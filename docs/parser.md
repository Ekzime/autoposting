# Парсер Telegram каналов

## Описание

Модуль парсера предназначен для мониторинга указанных Telegram каналов и сохранения сообщений в базу данных. Парсер автоматически подключается к указанным источникам, при необходимости присоединяется к ним и слушает новые сообщения.

## Компоненты

1. `parser.py` - основные функции парсинга и обработки сообщений
2. `parser_service.py` - сервис, управляющий жизненным циклом парсера
3. `telegram_requests.py` - вспомогательные функции для работы с API Telegram
4. `config.py` - конфигурация парсера

## Настройка

Для работы парсера необходимо указать следующие параметры в файле `.env` в корне проекта:

```
# Telegram API
API_ID=123456
API_HASH=abcdef1234567890abcdef1234567890

# Telegram парсер
PHONE_NUMBER=+79001234567  # Опционально, используется для устаревшего метода
SESSION=telegram_session    # Имя файла сессии
PHOTO_STORAGE=database/photos  # Папка для сохранения фото
```

## Принцип работы

1. Парсер запускается вместе с основным приложением
2. Проверяет наличие активного аккаунта и списка источников в БД
3. Если аккаунт найден, создает клиент Telegram и подключается
4. Присоединяется к указанным каналам, если пользователь не состоит в них
5. Устанавливает обработчики новых сообщений
6. При получении нового сообщения обрабатывает его:
   - Извлекает текст, фото, ссылки
   - Получает количество просмотров
   - Сохраняет в базу данных

## Обновления списков каналов и аккаунтов

Парсер автоматически отслеживает изменения в базе данных:
- При добавлении/удалении источника парсинга
- При изменении/активации/деактивации аккаунта

Для принудительного обновления без перезапуска используйте функцию `trigger_update()`.

## Управление через бота

Управление аккаунтами и источниками осуществляется через Telegram бота с помощью команд:

**Аккаунты Telegram:**
- `/add_account` - добавить новый аккаунт
- `/view_accounts` - просмотреть список аккаунтов
- `/activate_account ID` - активировать аккаунт с указанным ID
- `/deactivate_account ID` - деактивировать аккаунт
- `/delete_account ID` - удалить аккаунт

**Источники парсинга:**
- `/add_source` - добавить новый источник
- `/view_sources` - просмотреть источники
- `/update_source ID` - обновить существующий источник
- `/delete_source ID` - удалить источник

## Обработка ошибок

Парсер содержит обработку следующих ошибок:
- Отсутствие активного аккаунта
- Ошибки авторизации аккаунта
- Невозможность присоединиться к каналу
- Ошибки при сохранении сообщений

Все ошибки логируются с уровнем `ERROR`. 