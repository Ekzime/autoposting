# Telegram Parser для Автопостинга

Модуль парсера Telegram предназначен для мониторинга каналов и сбора сообщений в базу данных для дальнейшего анализа и обработки.

## Архитектура

Парсер использует асинхронную архитектуру на базе `asyncio` и библиотеки [Telethon](https://github.com/LonamiWebs/Telethon) для работы с Telegram API. Основные компоненты:

- **TelegramClient** - клиент для подключения к Telegram API
- **Обработчики событий** - асинхронные функции для обработки новых сообщений
- **Цикл обновлений** - периодическая проверка активных аккаунтов и каналов
- **База данных** - хранение информации о каналах, сообщениях и ссылках

## Принцип работы

1. Парсер загружает конфигурацию из `.env` файла
2. Получает активный аккаунт и список каналов для мониторинга из БД
3. Подключается к API Telegram используя данные аккаунта
4. Устанавливает обработчики событий для отслеживаемых каналов
5. При получении новых сообщений сохраняет их в БД
6. Периодически проверяет изменения в списке каналов и активного аккаунта

## Инициализация и запуск

Парсер может быть запущен двумя способами:

### 1. Как отдельный сервис:

```bash
python -m telegram.parser.parser_service
```

### 2. Как часть основного приложения:

```python
from telegram.parser.parser_service import start_parser_service

# Запуск сервиса
parser_task = start_parser_service()

# Остановка сервиса
parser_task.cancel()
```

## Структура данных

Парсер работает со следующими типами данных:

- **Каналы**: ID, title, description, username, peer_id
- **Сообщения**: ID, текст, дата, фото, просмотры
- **Ссылки**: URL, извлеченные из сообщений

## Обработка ошибок

Парсер обеспечивает устойчивость к ошибкам:

- Таймауты для всех сетевых операций
- Обработка исключений на всех уровнях
- Повторные попытки подключения при сбоях
- Логирование всех ошибок

## Алгоритм работы

```
┌─── Запуск парсера ───┐
│                      │
│  ┌── Цикл обновлений ──────────────────────────────┐
│  │                                                 │
│  │  1. Получить активный аккаунт из БД             │
│  │  2. Если аккаунт новый, инициализировать клиент │
│  │  3. Получить список источников из БД            │
│  │  4. Если список изменился:                      │
│  │     - Подключиться к новым каналам              │
│  │     - Настроить обработчики сообщений           │
│  │  5. Ждать 60 секунд                            │
│  │                                                 │
│  └─────────────────────────────────────────────────┘
│
│  ┌── Обработка новых сообщений ──────────────────────┐
│  │                                                   │
│  │  1. Обработать событие нового сообщения           │
│  │  2. Проверить наличие канала в БД                 │
│  │  3. Обработать вложения (фото, ссылки)            │
│  │  4. Получить количество просмотров                │
│  │  5. Сохранить в БД                                │
│  │                                                   │
│  └───────────────────────────────────────────────────┘
│
└──────────────────────┘
```

## Настройка

Настройки парсера находятся в файле `.env`:

```
# API настройки Telegram
API_ID=123456
API_HASH=your_api_hash

# Настройки парсера
PHOTO_STORAGE=database/photos
```

## Зависимости

- Python 3.8+
- Telethon 1.24+
- SQLAlchemy 2.0+
- aiohttp 3.8+

## Правила безопасности

- Никогда не публикуйте API_ID и API_HASH
- Не парсите слишком много каналов с одного аккаунта
- Не используйте для парсинга основной аккаунт

## Отладка и диагностика

Для диагностики проблем:

1. Проверьте файл логов `parser_debug.log`
2. Убедитесь, что аккаунт активен в БД
3. Проверьте наличие источников в БД
4. Запустите с повышенным уровнем логирования:

```bash
python -m telegram.parser.parser_service --debug
```

## Особенности и ограничения

1. Парсер работает только с публичными каналами или каналами, к которым у аккаунта есть доступ
2. Высокая частота запросов может привести к блокировке аккаунта
3. Изображения сохраняются в локальную файловую систему
4. Работа на Windows требует специальной настройки event loop policy 