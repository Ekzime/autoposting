# TODO: Глобальный рефакторинг и расширение функционала

## 1. Управление рекламным блоком (подвалом) через бота

### Проблема
Сейчас рекламный блок со ссылками жестко закодирован в функции `create_promotional_block()`. Это делает его изменение неудобным и требует вмешательства в код.

### Задача
Реализовать механизм управления ссылками в рекламном блоке через команды Telegram-бота, доступные администраторам.

### План работ
- [ ] **База данных:** Создать новую таблицу для хранения рекламных ссылок (например, `promotional_links` с полями `id`, `url`, `text`).
- [ ] **DAO-слой:** Создать репозиторий для CRUD-операций с таблицей `promotional_links`.
- [ ] **Хендлеры:** Разработать новые хендлеры для администраторов:
    - [ ] `/add_promo_link <ссылка> <описание>` - для добавления новой ссылки.
    - [ ] `/list_promo_links` - для просмотра всех текущих ссылок с их ID.
    - [ ] `/delete_promo_link <ID>` - для удаления ссылки по её ID.
- [ ] **Логика:** Модифицировать функцию `create_promotional_block()` для динамического формирования блока на основе данных из БД.
- [ ] **Безопасность:** Убедиться, что все новые хендлеры защищены проверкой прав администратора.

---

## 2. Улучшение обработки изображений и контента

### Проблема
Текущая реализация обрабатывает только одно изображение на пост и не имеет запасного варианта для постов без изображений.

### Задача
Расширить функционал для поддержки нескольких изображений (альбомов) и автоматической генерации превью с помощью ИИ для постов без картинок.

### План работ
- [ ] **Поддержка нескольких изображений (альбомов):**
    - [ ] **Парсер:** Модифицировать парсер для обнаружения и сохранения всех изображений из одного поста.
    - [ ] **База данных:** Изменить схему БД для связи одного сообщения с несколькими файлами изображений (например, создать таблицу `message_photos` со связью `FOREIGN KEY` к `messages`).
    - [ ] **Постинг:** Обновить `posting_worker` для использования `send_media_group`, если к сообщению привязано несколько фотографий.
- [ ] **Генерация превью с помощью ИИ:**
    - [ ] **Интеграция:** Выбрать и интегрировать API сервиса для генерации изображений (например, DALL-E, Stable Diffusion).
    - [ ] **Логика:** В `posting_worker`, если у поста нет изображений, вызывать ИИ-сервис для генерации картинки на основе текста поста.
    - [ ] **Конфигурация:** Добавить в `config.py` и `.env` настройки для включения/выключения этой функции и хранения API-ключа.

---

## 3. Интеграция сервиса парсинга веб-страниц (Firecrawl)

### Проблема
Бот не извлекает контент с внешних сайтов, ссылки на которые могут содержаться в постах.

### Задача
Создать отдельный сервис, который будет использовать Firecrawl для парсинга веб-страниц, если в исходном посте есть ссылка и функция активирована администратором.

### План работ
- [ ] **Создание микросервиса:**
    - [ ] Разработать легковесный сервис (например, на FastAPI), который принимает URL и возвращает его содержимое, обработанное через Firecrawl.
    - [ ] Добавить новый сервис в `docker-compose.yml`.
- [ ] **Интеграция с парсером:**
    - [ ] В логике парсера Telethon добавить проверку на наличие ссылок в тексте сообщения.
    - [ ] Если ссылка найдена и функция парсинга сайтов включена, отправлять запрос в сервис Firecrawl.
    - [ ] Сохранять полученный с сайта контент в БД вместе с основным текстом поста.
- [ ] **Управление функцией:**
    - [ ] Создать хендлер для администраторов (`/toggle_web_parser`) для включения/выключения парсинга веб-страниц.
    - [ ] Сохранять состояние этой настройки в БД.

---

## 4. Реализация сводок и аналитики

### Проблема
Отсутствует автоматизированный сбор статистики и подведение итогов работы.

### Задача
Реализовать автоматическую генерацию и отправку ежедневных и еженедельных отчетов о проделанной работе.

### План работ
- [ ] **Фоновый планировщик:** Интегрировать `apscheduler` или аналогичный инструмент для запуска периодических задач.
- [ ] **Логика сбора данных:** Разработать функции, которые будут запрашивать из БД данные за последние 24 часа / 7 дней (например, количество спарсенных постов, количество опубликованных, ошибки и т.д.).
- [ ] **Формирование отчета:** Создать шаблон для итогового сообщения.
- [ ] **Отправка:** Настроить отправку сгенерированного отчета в специальный административный канал или в личные сообщения администраторам.

---

## 5. Перенос базы данных в Docker

### Проблема
Локальный запуск базы данных усложняет развертывание и может приводить к несоответствиям в окружениях.

### Задача
Инкапсулировать базу данных (например, PostgreSQL) в Docker-контейнер с помощью `docker-compose`.

### План работ
- [ ] Создать или обновить файл `docker-compose.yml`.
- [ ] Добавить сервис для базы данных (например, `postgres`).
- [ ] Настроить переменные окружения для подключения к БД и `volume` для персистентного хранения данных.
- [ ] Обновить конфигурацию приложения (`config.py`, `.env.example`) для работы с БД из Docker.
- [ ] Добавить в `README.md` инструкцию по запуску проекта с помощью `docker-compose up`.

---

## 6. Завершение системы авторизации администраторов

### Проблема
Система авторизации (`AuthService`) может быть не интегрирована во все административные команды.

### Задача
Обеспечить проверку активной сессии администратора для всех хендлеров, выполняющих привилегированные действия.

### План работ
- [ ] Создать middleware для Aiogram, который будет вызывать `AuthService.verify_session(user_id)` для каждого запроса.
- [ ] Применить middleware ко всем роутерам, содержащим команды для администраторов.
- [ ] Настроить ответ бота для неавторизованных пользователей.

---

## 7. Планирование разработки веб-панели управления

### Проблема
Управление сложными сущностями через Telegram-команды может быть неэффективным.

### Задача
Спроектировать и спланировать разработку отдельного веб-сервиса (админ-панели).

### План работ (Проектирование)
- [ ] **Выбор технологического стека:** Backend (FastAPI), Frontend (React/Vue/Jinja2).
- [ ] **Проектирование API:** Разработать эндпоинты для аутентификации, CRUD-операций (каналы, аккаунты, промо-ссылки), управления настройками (вкл/выкл Firecrawl, ИИ-превью) и получения статистики.
- [ ] **Проектирование UI/UX:** Создать макеты ключевых страниц: дашборд, управление каналами, настройки, просмотр постов.
- [ ] **Декомпозиция разработки:** Разбить разработку на этапы и создать задачи в трекере.

